/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package fi.c5.juustofraktaalit.kali;

import fi.c5.juustofraktaalit.fraktaalit.FraktaaliTyyppi;
import fi.c5.juustofraktaalit.fraktaalit.Tyokalut;
import fi.c5.juustofraktaalit.hajauttaja.Hajauttaja;
import fi.c5.juustofraktaalit.hajauttaja.Kuvapinta;
import fi.c5.juustofraktaalit.hajauttaja.Suorittaja;
import fi.c5.juustofraktaalit.hajauttaja.TyoMaarays;
import fi.c5.juustofraktaalit.hajauttaja.TyoVaihe;

/**
 *
 * @author Teemu Heikkilä
 */
public class Fraktaaliselain extends javax.swing.JFrame {
    Double keskipiste_x;
    Double keskipiste_y;
    int zoomTaso;
    Double zoom;
    /**
     * Creates new form Fraktaaliselain
     */
    public Fraktaaliselain() {
        initComponents();
        this.tila = new Tilanne(this.tilaKentta);
        tila.asetaTila("Valmis!");
        this.keskipiste_x = -1.0;
        this.keskipiste_y = 0.0;
        this.zoomTaso = 0;
        this.zoom = 1.5;
        paivitaLisatiedot();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        asetusPaneeli = new javax.swing.JPanel();
        algoritmiOtsikko = new javax.swing.JLabel();
        algoritmiValinta = new javax.swing.JComboBox();
        hajautusOtsikko = new javax.swing.JLabel();
        renderoiNappi = new javax.swing.JButton();
        hajautusSlideri = new javax.swing.JSlider();
        tilaOtsikko = new javax.swing.JLabel();
        tilaKentta = new javax.swing.JTextField();
        valitonRenderointiCheckbox = new javax.swing.JCheckBox();
        liikuteltavaPaneeli = new javax.swing.JScrollPane();
        piirtaja = new fi.c5.juustofraktaalit.kali.Piirtaja();
        jToolBar1 = new javax.swing.JToolBar();
        keskipisteOtsikko = new javax.swing.JLabel();
        jSeparator1 = new javax.swing.JToolBar.Separator();
        zoomOtsikko = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("Juustofraktaalit");

        asetusPaneeli.setBorder(javax.swing.BorderFactory.createTitledBorder("Asetukset"));

        algoritmiOtsikko.setText("Algoritmi");

        algoritmiValinta.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Mandelbrot", "Julia" }));

        hajautusOtsikko.setText("Hajautus");

        renderoiNappi.setText("Renderöi");
        renderoiNappi.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                renderoiNappiActionPerformed(evt);
            }
        });

        hajautusSlideri.setMaximum(16);
        hajautusSlideri.setMinimum(1);
        hajautusSlideri.setPaintLabels(true);
        hajautusSlideri.setPaintTicks(true);
        hajautusSlideri.setSnapToTicks(true);
        hajautusSlideri.setValue(1);
        hajautusSlideri.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                hajautusSlideriStateChanged(evt);
            }
        });

        tilaOtsikko.setText("Tila");

        tilaKentta.setEditable(false);
        tilaKentta.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                tilaKenttaActionPerformed(evt);
            }
        });

        valitonRenderointiCheckbox.setText("Välitön renderöinti?");
        valitonRenderointiCheckbox.setFocusable(false);
        valitonRenderointiCheckbox.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        valitonRenderointiCheckbox.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);

        javax.swing.GroupLayout asetusPaneeliLayout = new javax.swing.GroupLayout(asetusPaneeli);
        asetusPaneeli.setLayout(asetusPaneeliLayout);
        asetusPaneeliLayout.setHorizontalGroup(
            asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(asetusPaneeliLayout.createSequentialGroup()
                .addComponent(algoritmiOtsikko)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(algoritmiValinta, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(renderoiNappi, javax.swing.GroupLayout.PREFERRED_SIZE, 280, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
            .addGroup(asetusPaneeliLayout.createSequentialGroup()
                .addGroup(asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(hajautusOtsikko)
                    .addComponent(tilaOtsikko))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(asetusPaneeliLayout.createSequentialGroup()
                        .addComponent(hajautusSlideri, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(valitonRenderointiCheckbox, javax.swing.GroupLayout.PREFERRED_SIZE, 220, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(102, 102, 102))
                    .addComponent(tilaKentta, javax.swing.GroupLayout.PREFERRED_SIZE, 524, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(0, 0, Short.MAX_VALUE))
        );
        asetusPaneeliLayout.setVerticalGroup(
            asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(asetusPaneeliLayout.createSequentialGroup()
                .addGroup(asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(asetusPaneeliLayout.createSequentialGroup()
                        .addGroup(asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addGroup(asetusPaneeliLayout.createSequentialGroup()
                                .addGroup(asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                    .addComponent(algoritmiOtsikko)
                                    .addComponent(algoritmiValinta, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                                .addGap(36, 36, 36)
                                .addGroup(asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(hajautusOtsikko)
                                    .addComponent(hajautusSlideri, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                            .addGroup(asetusPaneeliLayout.createSequentialGroup()
                                .addContainerGap()
                                .addComponent(renderoiNappi, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, asetusPaneeliLayout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addComponent(valitonRenderointiCheckbox, javax.swing.GroupLayout.PREFERRED_SIZE, 80, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(39, 39, 39)))
                .addGroup(asetusPaneeliLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(tilaOtsikko)
                    .addComponent(tilaKentta, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap())
        );

        piirtaja.addMouseWheelListener(new java.awt.event.MouseWheelListener() {
            public void mouseWheelMoved(java.awt.event.MouseWheelEvent evt) {
                piirtajaMouseWheelMoved(evt);
            }
        });
        piirtaja.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mousePressed(java.awt.event.MouseEvent evt) {
                piirtajaMousePressed(evt);
            }
        });

        javax.swing.GroupLayout piirtajaLayout = new javax.swing.GroupLayout(piirtaja);
        piirtaja.setLayout(piirtajaLayout);
        piirtajaLayout.setHorizontalGroup(
            piirtajaLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 803, Short.MAX_VALUE)
        );
        piirtajaLayout.setVerticalGroup(
            piirtajaLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 437, Short.MAX_VALUE)
        );

        liikuteltavaPaneeli.setViewportView(piirtaja);

        jToolBar1.setRollover(true);

        keskipisteOtsikko.setText("keskipiste");
        jToolBar1.add(keskipisteOtsikko);
        jToolBar1.add(jSeparator1);

        zoomOtsikko.setText("zoom");
        jToolBar1.add(zoomOtsikko);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(asetusPaneeli, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(liikuteltavaPaneeli)
            .addComponent(jToolBar1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addComponent(liikuteltavaPaneeli, javax.swing.GroupLayout.PREFERRED_SIZE, 413, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jToolBar1, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(asetusPaneeli, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents
    private void renderoi(){
        tila.asetaTila("Renderöinti aloitettu!");
        TyoMaarays t = new TyoMaarays(FraktaaliTyyppi.MANDELBROT, null, new Kuvapinta(this.piirtaja.getWidth(), this.piirtaja.getHeight()), this.hajautusSlideri.getValue());
        t.asetaAlue(keskipiste_x, keskipiste_y, zoom);
        Hajauttaja h = new Hajauttaja(t);
        Suorittaja v1 = new Suorittaja(h, this.tila, t, this.piirtaja);
        v1.execute();
        
    }
    private void renderoiNappiActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_renderoiNappiActionPerformed
        renderoi();
    }//GEN-LAST:event_renderoiNappiActionPerformed
    private void paivitaLisatiedot(){
        keskipisteOtsikko.setText("Keskipiste: ("+keskipiste_x+","+keskipiste_y+")");
        zoomOtsikko.setText("Zoom: "+ zoom);
    }
    private void tilaKenttaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_tilaKenttaActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_tilaKenttaActionPerformed

    private void hajautusSlideriStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_hajautusSlideriStateChanged
        // TODO add your handling code here:
        tila.asetaTila("Hajautus asetettu arvoon " +hajautusSlideri.getValue()+" -> Renderöitäessä luodaan " + Math.pow(hajautusSlideri.getValue(), 2)+" säiettä.");            
    }//GEN-LAST:event_hajautusSlideriStateChanged

    private void piirtajaMouseWheelMoved(java.awt.event.MouseWheelEvent evt) {//GEN-FIRST:event_piirtajaMouseWheelMoved
        zoomTaso += Math.pow(evt.getWheelRotation(), Math.max(2, zoomTaso))*Math.signum(evt.getWheelRotation());
        zoom = 1.0 / Math.max(zoomTaso, .5);
        paivitaLisatiedot();
    }//GEN-LAST:event_piirtajaMouseWheelMoved

    private void piirtajaMousePressed(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_piirtajaMousePressed
        // TODO add your handling code here:
        maaritaKeskipiste(evt.getX(), evt.getY());
        paivitaLisatiedot();
        if (this.valitonRenderointiCheckbox.isSelected()) {
            renderoi();
        }
    }//GEN-LAST:event_piirtajaMousePressed
    private void maaritaKeskipiste(int uusiPPX, int uusiPPY) {
        double suhdeX = (double)uusiPPX/(double)this.piirtaja.getWidth();        
        double suhdeY = (double)uusiPPY/(double)this.piirtaja.getHeight();
        keskipiste_x = Tyokalut.map(suhdeX, 0, 1, keskipiste_x-zoom, keskipiste_x+zoom);
        keskipiste_y = Tyokalut.map(suhdeY, 0, 1, keskipiste_y-zoom, keskipiste_y+zoom);
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel algoritmiOtsikko;
    private javax.swing.JComboBox algoritmiValinta;
    private javax.swing.JPanel asetusPaneeli;
    private javax.swing.JLabel hajautusOtsikko;
    private javax.swing.JSlider hajautusSlideri;
    private javax.swing.JToolBar.Separator jSeparator1;
    private javax.swing.JToolBar jToolBar1;
    private javax.swing.JLabel keskipisteOtsikko;
    private javax.swing.JScrollPane liikuteltavaPaneeli;
    private fi.c5.juustofraktaalit.kali.Piirtaja piirtaja;
    private javax.swing.JButton renderoiNappi;
    private javax.swing.JTextField tilaKentta;
    private javax.swing.JLabel tilaOtsikko;
    private javax.swing.JCheckBox valitonRenderointiCheckbox;
    private javax.swing.JLabel zoomOtsikko;
    // End of variables declaration//GEN-END:variables
    private Tilanne tila;
}
